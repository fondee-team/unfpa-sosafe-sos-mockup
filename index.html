<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOS Emergency System Mockup</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .mobile-frame {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        /* Pulse Animation for SOS */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-pulse-red {
            animation: pulse-red 2s infinite;
        }
        /* Simulated LINE UI */
        .line-header { background-color: #2b3441; color: white; }
        .line-bg { background-color: #8da4ce; }
        .message-bubble { background-color: white; border-radius: 12px; padding: 10px; max-width: 80%; position: relative; }
        .message-bubble::before {
            content: ''; position: absolute; left: -6px; top: 10px;
            border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-right: 6px solid white;
        }
        .message-bubble.right { margin-left: auto; background-color: #dcf8c6; }
        .message-bubble.right::before {
            left: auto; right: -6px; border-right: none; border-left: 6px solid #dcf8c6;
        }

        .rich-menu { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: white; border-top: 1px solid #ddd; height: 200px; 
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
        }
        
        /* Hold Button Animation */
        .hold-progress {
            transition: width 0.1s linear;
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Pin Pad Key Animation */
        .pin-key:active {
            background-color: rgba(255,255,255,0.2);
            transform: scale(0.95);
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

const { useState, useEffect, useRef } = React;

// --- Components ---

// 1. Home / Mode Selection
const HomeSelector = ({ setView }) => (
    <div className="flex flex-col items-center justify-center h-screen bg-gray-100 p-4">
        <h1 className="text-3xl font-bold mb-2 text-blue-900">SOS Mockup</h1>
        <p className="text-gray-600 mb-8 text-center">จำลองระบบแจ้งเหตุ + 2-Factor Unlock</p>
        
        <div className="space-y-4 w-full max-w-xs">
            <button 
                onClick={() => setView('sender_chat')}
                className="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition"
            >
                <i data-lucide="user" className="w-6 h-6"></i>
                <div>
                    <div className="font-bold text-lg">ฝั่งคนแจ้ง (ผู้ประสบภัย)</div>
                    <div className="text-xs opacity-90">ทดสอบ Stealth & PIN Unlock</div>
                </div>
            </button>

            <button 
                onClick={() => setView('receiver_chat')}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition"
            >
                <i data-lucide="shield-alert" className="w-6 h-6"></i>
                <div>
                    <div className="font-bold text-lg">ฝั่งคนรับ (Help Center)</div>
                    <div className="text-xs opacity-90">ดูพิกัด & รหัสปลดล็อค</div>
                </div>
            </button>
            
            <div className="mt-8 p-4 bg-white rounded-lg text-sm text-gray-500 border border-gray-200">
                <h3 className="font-bold mb-2">อัปเดตล่าสุด:</h3>
                <ul className="list-disc pl-4 space-y-1 text-xs">
                    <li>Stealth Mode: จอดำสนิท</li>
                    <li><b>Random Unlock:</b> สุ่มวิธีปลดล็อค (Gesture)</li>
                    <li><b>PIN Security:</b> ต้องใส่ PIN หลังจากทำ Gesture</li>
                    <li>ต้องดู PIN จากฝั่ง "คนรับ" หรือหน้า Demo</li>
                </ul>
            </div>
        </div>
    </div>
);

// 2. Sender: LINE Chat View (Rich Menu)
const SenderChat = ({ setView, onOpenSOS }) => (
    <div className="mobile-frame flex flex-col">
        {/* Header */}
        <div className="line-header p-4 flex items-center justify-between shadow-sm z-10">
            <div className="flex items-center gap-3">
                <button onClick={() => setView('home')} className="text-white"><i data-lucide="chevron-left"></i></button>
                <span className="font-bold text-lg">SOS Service OA</span>
            </div>
            <i data-lucide="menu"></i>
        </div>

        {/* Chat Area */}
        <div className="line-bg flex-1 p-4 overflow-y-auto pb-64">
            <div className="text-center text-xs text-white mb-4 bg-black/20 rounded-full py-1 px-3 mx-auto w-fit">วันนี้</div>
            
            {/* Bot Greeting */}
            <div className="flex items-start gap-2 mb-4">
                <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs">SOS</div>
                <div className="flex flex-col gap-1">
                    <span className="text-xs text-gray-700">SOS System</span>
                    <div className="message-bubble text-sm">
                        ระบบพร้อมใช้งาน<br/>
                        หากเกิดเหตุฉุกเฉิน กดปุ่ม SOS ด้านล่าง<br/>
                        <span className="text-red-500 text-xs font-bold">*Security Update: 2-Step Unlock (Gesture + PIN)</span>
                    </div>
                </div>
            </div>
        </div>

        {/* Rich Menu (Simulated) */}
        <div className="rich-menu shadow-lg">
            <div 
                onClick={onOpenSOS}
                className="col-span-2 row-span-2 bg-red-500 m-1 rounded-lg flex flex-col items-center justify-center text-white cursor-pointer active:scale-95 transition relative overflow-hidden group"
            >
                <div className="absolute inset-0 bg-gradient-to-t from-red-900/30 to-transparent"></div>
                <i data-lucide="alert-circle" className="w-16 h-16 mb-2 group-hover:scale-110 transition-transform"></i>
                <span className="text-2xl font-bold uppercase tracking-wider">ขอความช่วยเหลือ</span>
                <span className="text-sm opacity-90">(SOS Emergency)</span>
            </div>
        </div>
    </div>
);

// 3. Sender: LIFF SOS Interface (Long Press & Secure Stealth)
const SosLiff = ({ onClose, onLocationUpdate }) => {
    // Modes: 'standby', 'holding', 'sending', 'stealth'
    const [mode, setMode] = useState('standby');
    const [progress, setProgress] = useState(0);
    const [trackCount, setTrackCount] = useState(0);
    
    // Unlock Logic State
    const [activeUnlockMethod, setActiveUnlockMethod] = useState(null); // The chosen gesture
    const [unlockPin, setUnlockPin] = useState(null); // The random PIN
    const [showPinPad, setShowPinPad] = useState(false); // Show keypad after gesture success
    const [enteredPin, setEnteredPin] = useState(''); // User typed PIN
    const [pinError, setPinError] = useState(false);

    // Gesture detection vars
    const [tapCount, setTapCount] = useState(0); 
    const holdTimer = useRef(null);
    const trackingInterval = useRef(null);
    const tapResetTimer = useRef(null);
    const touchStartRef = useRef(null);
    const unlockHoldTimer = useRef(null);

    // Clean up on unmount
    useEffect(() => {
        return () => {
            clearInterval(holdTimer.current);
            clearInterval(trackingInterval.current);
            clearTimeout(tapResetTimer.current);
            clearTimeout(unlockHoldTimer.current);
        };
    }, []);

    const startHolding = () => {
        setMode('holding');
        let p = 0;
        holdTimer.current = setInterval(() => {
            p += 2;
            if (p >= 100) {
                p = 100;
                clearInterval(holdTimer.current);
                handleSendSOS();
            }
            setProgress(p);
        }, 20); 
    };

    const stopHolding = () => {
        if (mode === 'sending' || mode === 'stealth') return;
        clearInterval(holdTimer.current);
        setMode('standby');
        setProgress(0);
    };

    const handleSendSOS = () => {
        setMode('sending');

        // Randomize Unlock Method (Gesture)
        const methods = [
            { id: 'triple_tap', label: 'แตะหน้าจอ 3 ครั้งเร็วๆ' },
            { id: 'long_press', label: 'กดหน้าจอค้างไว้ 3 วินาที' },
            { id: 'swipe_up', label: 'ปัดหน้าจอขึ้นด้านบน' }
        ];
        const selectedMethod = methods[Math.floor(Math.random() * methods.length)];
        setActiveUnlockMethod(selectedMethod);

        // Randomize PIN
        const generatedPin = Math.floor(1000 + Math.random() * 9000).toString();
        setUnlockPin(generatedPin);

        setTimeout(() => {
            // Send Initial Data
            onLocationUpdate({ 
                lat: 13.7563, lng: 100.5018, 
                time: new Date().toLocaleTimeString(),
                status: 'Initial Alert',
                unlockMethod: selectedMethod.label,
                pin: generatedPin
            });
            startStealthTracking();
        }, 1500);
    };

    const startStealthTracking = () => {
        setMode('stealth');
        trackingInterval.current = setInterval(() => {
            setTrackCount(prev => prev + 1);
            const latOffset = (Math.random() - 0.5) * 0.001;
            const lngOffset = (Math.random() - 0.5) * 0.001;
            
            onLocationUpdate({
                lat: 13.7563 + latOffset,
                lng: 100.5018 + lngOffset,
                time: new Date().toLocaleTimeString(),
                status: 'Tracking Update'
            });
        }, 5000);
    };

    // --- STEALTH GESTURE HANDLERS ---
    
    const handleGestureSuccess = () => {
        // First step (Gesture) passed, now show PIN pad
        setShowPinPad(true);
    };

    const handleTouchStart = (e) => {
        if (mode !== 'stealth' || showPinPad || !activeUnlockMethod) return;

        // Swipe Up Logic (Start)
        if (activeUnlockMethod.id === 'swipe_up') {
            touchStartRef.current = e.touches ? e.touches[0].clientY : e.clientY;
        }

        // Long Press Logic (Start)
        if (activeUnlockMethod.id === 'long_press') {
            unlockHoldTimer.current = setTimeout(() => {
                handleGestureSuccess(); // Unlock Step 1
            }, 3000);
        }
    };

    const handleTouchEnd = (e) => {
        if (mode !== 'stealth' || showPinPad || !activeUnlockMethod) return;

        // Swipe Up Logic (End)
        if (activeUnlockMethod.id === 'swipe_up' && touchStartRef.current !== null) {
            const touchEnd = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            if (touchStartRef.current - touchEnd > 150) { // Swiped up significantly
                handleGestureSuccess();
            }
            touchStartRef.current = null;
        }

        // Long Press Logic (End/Cancel)
        if (activeUnlockMethod.id === 'long_press') {
            clearTimeout(unlockHoldTimer.current);
        }
    };

    const handleClick = () => {
        if (mode !== 'stealth' || showPinPad || !activeUnlockMethod) return;

        // Triple Tap Logic
        if (activeUnlockMethod.id === 'triple_tap') {
            setTapCount(prev => prev + 1);
            
            clearTimeout(tapResetTimer.current);
            tapResetTimer.current = setTimeout(() => {
                setTapCount(0);
            }, 500);

            if (tapCount + 1 >= 3) {
                handleGestureSuccess();
            }
        }
    };

    // --- PIN PAD HANDLERS ---
    
    const handlePinInput = (num) => {
        if (enteredPin.length < 4) {
            const newPin = enteredPin + num;
            setEnteredPin(newPin);
            
            if (newPin.length === 4) {
                // Check PIN
                if (newPin === unlockPin) {
                    onClose(); // FULL UNLOCK
                } else {
                    setPinError(true);
                    setTimeout(() => {
                        setEnteredPin('');
                        setPinError(false);
                    }, 500);
                }
            }
        }
    };

    const handleDelete = () => {
        setEnteredPin(prev => prev.slice(0, -1));
    };

    // Stealth Mode Screen (True Black / Demo Info)
    if (mode === 'stealth') {
        if (showPinPad) {
            return (
                <div className="fixed inset-0 bg-black z-[120] flex flex-col items-center justify-center text-white">
                    <h2 className="text-xl mb-6 font-bold">กรุณาใส่ PIN</h2>
                    <div className={`flex gap-3 mb-8 ${pinError ? 'shake' : ''}`}>
                        {[0, 1, 2, 3].map(i => (
                            <div key={i} className={`w-4 h-4 rounded-full border border-white ${enteredPin.length > i ? 'bg-white' : ''}`}></div>
                        ))}
                    </div>
                    
                    <div className="grid grid-cols-3 gap-6">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                            <button key={num} onClick={() => handlePinInput(num.toString())} className="pin-key w-16 h-16 rounded-full bg-gray-800 text-2xl font-bold flex items-center justify-center hover:bg-gray-700 transition-colors">
                                {num}
                            </button>
                        ))}
                        <div className="w-16 h-16"></div>
                        <button onClick={() => handlePinInput("0")} className="pin-key w-16 h-16 rounded-full bg-gray-800 text-2xl font-bold flex items-center justify-center hover:bg-gray-700 transition-colors">0</button>
                        <button onClick={handleDelete} className="pin-key w-16 h-16 rounded-full text-red-400 flex items-center justify-center hover:bg-gray-900 transition-colors">
                            <i data-lucide="delete" className="w-6 h-6"></i>
                        </button>
                    </div>
                    <button onClick={() => setShowPinPad(false)} className="mt-8 text-gray-500 text-sm">Cancel</button>
                </div>
            );
        }

        return (
            <div 
                onClick={handleClick}
                onTouchStart={handleTouchStart}
                onTouchEnd={handleTouchEnd}
                onMouseDown={handleTouchStart} // For desktop testing
                onMouseUp={handleTouchEnd}     // For desktop testing
                className="fixed inset-0 bg-black z-[100] cursor-default flex flex-col items-center justify-center select-none touch-manipulation text-white p-8 text-center"
            >
                {/* DEMO ONLY: Show Unlock Method */}
                <div className="mb-8">
                    <h2 className="text-xl font-bold text-red-500 mb-2">DEMO MODE</h2>
                    
                    <div className="mb-4">
                        <p className="text-sm opacity-70 mb-1">1. Unlock Gesture:</p>
                        <div className="text-xl font-bold text-yellow-400 bg-gray-900 p-3 rounded-lg border border-yellow-600/50">
                            "{activeUnlockMethod?.label}"
                        </div>
                    </div>

                    <div>
                        <p className="text-sm opacity-70 mb-1">2. Unlock PIN:</p>
                        <div className="text-3xl font-mono font-bold text-green-400 bg-gray-900 p-3 rounded-lg border border-green-600/50 tracking-widest">
                            {unlockPin}
                        </div>
                    </div>
                </div>
                
                <p className="text-xs text-gray-600 max-w-md bg-gray-900/30 p-4 rounded-lg">
                    (ข้อความนี้แสดงเพื่อการ demo เท่านั้น <br/>ของจริงหน้าจอจะดำสนิท)
                </p>
                
                {/* Tiny feedback for testing purposes only (remove in prod) */}
                 <div className="absolute bottom-5 right-5 w-1 h-1 bg-gray-900 rounded-full animate-pulse"></div>
            </div>
        );
    }

    // Normal SOS Interface (Button)
    return (
        <div className="fixed inset-0 bg-white z-50 flex flex-col mobile-frame animate-fade-in select-none">
            {/* Header */}
            <div className="bg-gray-100 p-4 flex justify-between items-center shadow-sm">
                <h3 className="font-bold text-gray-700">ยืนยันการแจ้งเหตุ</h3>
                <button onClick={onClose} className="text-gray-500"><i data-lucide="x"></i></button>
            </div>

            <div className="flex-1 flex flex-col items-center justify-center p-6 relative">
                
                {mode === 'sending' ? (
                    <div className="text-center animate-pulse">
                        <i data-lucide="radio" className="w-20 h-20 text-red-500 mx-auto mb-4"></i>
                        <h2 className="text-2xl font-bold text-gray-800">กำลังส่งพิกัด...</h2>
                        <p className="text-gray-500">กรุณารอสักครู่</p>
                    </div>
                ) : (
                    <>
                        <div 
                            className={`w-48 h-48 rounded-full border-4 flex items-center justify-center mb-8 relative overflow-hidden transition-all duration-200 ${mode === 'holding' ? 'scale-110 border-red-500 shadow-xl' : 'border-gray-300 shadow-md'}`}
                            onMouseDown={startHolding}
                            onMouseUp={stopHolding}
                            onTouchStart={startHolding}
                            onTouchEnd={stopHolding}
                        >
                            <div 
                                className="absolute bottom-0 left-0 right-0 bg-red-500 transition-none"
                                style={{ height: `${progress}%` }}
                            ></div>

                            <div className="relative z-10 flex flex-col items-center pointer-events-none">
                                <i data-lucide="fingerprint" className={`w-16 h-16 mb-2 ${progress > 50 ? 'text-white' : 'text-red-500'}`}></i>
                                <span className={`font-bold text-lg ${progress > 50 ? 'text-white' : 'text-gray-700'}`}>
                                    {mode === 'holding' ? "กดค้างไว้!" : "กดค้าง 3 วิ"}
                                </span>
                            </div>
                        </div>

                        <p className="text-gray-500 text-center max-w-xs text-sm">
                            กดปุ่มสีแดงค้างไว้จนเต็มเพื่อส่งสัญญาณ <br/>
                            <span className="text-red-600 font-bold mt-2 block bg-red-50 p-2 rounded">
                                <i data-lucide="lock" className="inline w-3 h-3"></i> หลังส่ง จอจะดับทันที (Stealth)
                            </span>
                        </p>
                    </>
                )}
            </div>
        </div>
    );
};

// 4. Receiver: Chat View (Showing Unlock Key)
const ReceiverChat = ({ setView, emergencyLogs }) => {
    const bottomRef = useRef(null);

    useEffect(() => {
        bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [emergencyLogs]);

    return (
        <div className="mobile-frame flex flex-col">
            <div className="line-header p-4 flex items-center justify-between shadow-sm z-10">
                <div className="flex items-center gap-3">
                    <button onClick={() => setView('home')} className="text-white"><i data-lucide="chevron-left"></i></button>
                    <span className="font-bold text-lg">SOS Notifications</span>
                </div>
            </div>

            <div className="line-bg flex-1 p-4 overflow-y-auto">
                <div className="text-center text-xs text-white mb-4 bg-black/20 rounded-full py-1 px-3 mx-auto w-fit">วันนี้</div>
                
                {emergencyLogs.length === 0 && (
                    <div className="text-center text-white/70 text-sm mt-10 bg-black/10 p-2 rounded">
                        ยังไม่มีการแจ้งเหตุ
                    </div>
                )}

                {emergencyLogs.map((log, index) => (
                    <div key={index} className="flex items-start gap-2 mb-4 animate-fade-in-up">
                        <div className="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center text-white font-bold text-xs shadow-md shrink-0">SOS</div>
                        <div className="flex flex-col gap-1 w-full max-w-[85%]">
                            <span className="text-xs text-gray-700">System Alert</span>
                            <div className="bg-red-50 p-3 rounded-xl border border-red-200 shadow-sm relative before:absolute before:left-[-6px] before:top-[10px] before:border-t-[6px] before:border-t-transparent before:border-b-[6px] before:border-b-transparent before:border-r-[6px] before:border-r-red-50">
                                <h3 className="text-red-600 font-bold flex items-center gap-2 text-sm">
                                    {log.status === 'Initial Alert' ? <i data-lucide="bell-ring" className="w-4 h-4"></i> : <i data-lucide="navigation" className="w-4 h-4"></i>}
                                    {log.status === 'Initial Alert' ? 'แจ้งเหตุฉุกเฉิน!' : 'อัปเดตพิกัดต่อเนื่อง'}
                                </h3>
                                <p className="text-sm text-gray-800 mt-1">
                                    พิกัด: {log.lat.toFixed(4)}, {log.lng.toFixed(4)}
                                </p>
                                
                                {/* SECURE UNLOCK INSTRUCTION - Only visible to receiver */}
                                {log.status === 'Initial Alert' && (
                                    <div className="bg-white border-l-4 border-yellow-500 p-2 mt-2 rounded text-xs text-gray-600 shadow-sm">
                                        <div className="flex items-center gap-1 font-bold text-yellow-600 mb-1">
                                            <i data-lucide="lock-keyhole" className="w-3 h-3"></i> Stealth Unlock Info
                                        </div>
                                        <div className="text-xs text-gray-500 mb-1">ผู้ส่งหน้าจอดับอยู่ ต้องใช้วิธีด้านล่างปลดล็อค:</div>
                                        
                                        <div className="grid grid-cols-[auto_1fr] gap-2 items-center mb-1">
                                            <span className="bg-gray-200 text-gray-700 px-2 rounded text-xs font-bold">Step 1</span>
                                            <div className="font-bold text-black text-sm">{log.unlockMethod}</div>
                                        </div>
                                        
                                        <div className="grid grid-cols-[auto_1fr] gap-2 items-center">
                                            <span className="bg-red-100 text-red-700 px-2 rounded text-xs font-bold">Step 2</span>
                                            <div className="font-mono font-bold text-red-600 text-lg tracking-widest">{log.pin}</div>
                                        </div>
                                    </div>
                                )}

                                <p className="text-xs text-gray-400 mt-2 text-right">{log.time}</p>
                                
                                {index === emergencyLogs.length - 1 && (
                                    <div className="mt-3">
                                        <button 
                                            onClick={() => setView('receiver_map')}
                                            className="w-full bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-bold shadow hover:bg-red-700 flex items-center justify-center gap-2"
                                        >
                                            <i data-lucide="map"></i> ดูตำแหน่งปัจจุบัน
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
                <div ref={bottomRef}></div>
            </div>
        </div>
    );
};

// 5. Receiver: Map View (Unchanged)
const ReceiverMap = ({ onClose, latestLocation }) => {
    const mapRef = useRef(null);
    const markerRef = useRef(null);

    useEffect(() => {
        if (!mapRef.current) {
            const map = L.map('map').setView([latestLocation.lat, latestLocation.lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            mapRef.current = map;
        }
    }, []);

    useEffect(() => {
        if (mapRef.current && latestLocation) {
            const { lat, lng } = latestLocation;
            mapRef.current.panTo([lat, lng]);
            if (markerRef.current) {
                markerRef.current.setLatLng([lat, lng]);
            } else {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div style='background-color:#ef4444; width: 24px; height: 24px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);'></div>",
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                markerRef.current = L.marker([lat, lng], { icon: icon }).addTo(mapRef.current)
                    .bindPopup('<b>เป้าหมายอยู่ที่นี่</b><br>กำลังเคลื่อนที่...').openPopup();
            }
        }
    }, [latestLocation]);

    return (
        <div className="fixed inset-0 bg-white z-50 flex flex-col mobile-frame">
            <div className="bg-black text-white p-3 flex justify-between items-center text-sm">
                <span onClick={onClose} className="cursor-pointer font-bold text-lg"><i data-lucide="chevron-left" className="inline w-4"></i> Back</span>
                <span>Live Tracking</span>
                <span className="text-red-500 font-bold text-xs animate-pulse">● LIVE</span>
            </div>
            
            <div className="flex-1 relative bg-gray-200">
                <div id="map" className="w-full h-full"></div>
                <div className="absolute bottom-6 left-4 right-4 bg-white p-4 rounded-xl shadow-xl z-[1000]">
                    <div className="flex items-center justify-between mb-2">
                        <div>
                            <h3 className="font-bold text-gray-800">กำลังติดตาม: คุณแม่</h3>
                            <p className="text-xs text-gray-500">อัปเดตเมื่อ: {latestLocation?.time}</p>
                        </div>
                    </div>
                    <div className="w-full bg-gray-100 rounded-lg p-2 text-xs text-gray-600 mb-3">
                        พิกัด: {latestLocation?.lat.toFixed(5)}, {latestLocation?.lng.toFixed(5)}
                    </div>
                    <button className="w-full bg-red-600 text-white py-3 rounded-lg font-bold text-sm shadow-lg">
                        <i data-lucide="phone" className="inline w-4 h-4 mr-2"></i> โทรฉุกเฉิน
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- Main App ---

const App = () => {
    const [view, setView] = useState('home'); 
    const [showSenderLiff, setShowSenderLiff] = useState(false);
    const [emergencyLogs, setEmergencyLogs] = useState([]);

    useEffect(() => {
        lucide.createIcons();
    }, [view, showSenderLiff, emergencyLogs]);

    const handleSOS = () => {
        setShowSenderLiff(true);
    };

    const handleSenderLiffClose = () => {
        setShowSenderLiff(false);
    };

    const handleLocationUpdate = (data) => {
        setEmergencyLogs(prev => [...prev, data]);
    };

    return (
        <div className="bg-gray-100 min-h-screen">
            {view === 'home' && <HomeSelector setView={setView} />}
            
            {view === 'sender_chat' && (
                <>
                    <SenderChat setView={setView} onOpenSOS={handleSOS} />
                    {showSenderLiff && (
                        <SosLiff 
                            onClose={handleSenderLiffClose} 
                            onLocationUpdate={handleLocationUpdate} 
                        />
                    )}
                </>
            )}

            {view === 'receiver_chat' && (
                <ReceiverChat setView={setView} emergencyLogs={emergencyLogs} />
            )}

            {view === 'receiver_map' && (
                <ReceiverMap 
                    onClose={() => setView('receiver_chat')} 
                    latestLocation={emergencyLogs[emergencyLogs.length - 1] || {lat: 13.7563, lng: 100.5018, time: '-'}}
                />
            )}
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

</script>
</body>
</html>